<polymer-element name="upload-form" attributes="recipeFormUrl recipePicUrl">
  <template>
    <link rel="stylesheet" href="upload-form.css"/>

    <form action="{{recipeFormUrl}}" method="post" id="form">
      <paper-input id="cookbook-title" label="菜谱名称" floatinglabel value="{{cookbookTitle}}"></paper-input>

      <div id="main-pic-upload">
        <div class="plus-icon">
          <span class="plus-circled">+</span>
        </div>
        <div class="upload-note">上传美食的成品图（建议尺寸：600x400）</div>

        <file-input
          id="mainPic"
          accept="image/*"
          on-change="{{uploadMainPic}}"></file-input>

        <template if="{{mainPicUploading}}">
          <div class="spinner">
            <paper-spinner active></paper-spinner>
          </div>
        </template>
      </div>
      <textarea name="introduction" id="introduction" cols="30" rows="10" placeholder="介绍介绍你的美食吧，相关故事也可以哦"></textarea>

      <h2>食材</h2>
      <ul id="ingredients">
        <template repeat="{{ingredients}}">
          <li class="ingredient-item">
            <paper-input
              class="food_name"
              value="{{food_name}}"
              label="食材.如：鸡蛋"></paper-input>
            <paper-input
              class="food_quantity"
              value="{{food_quantity}}"
              label="分量.如：100g"></paper-input>
            <a class="delete-ingredients" on-tap="{{deleteIngredient}}" href="javascript:void (0)" tabindex="-1">X</a>
          </li>
        </template>
      </ul>
      <div class="add-ingredient">
        <paper-button raised on-tap="{{addIngredient}}">+添加一项食材</paper-button>
      </div>

      <h2>步骤</h2>
      <ol id="steps">
        <template repeat="{{steps}}">
          <li class="step-item">
            <div class="step-pic-upload">
              <div class="plus-icon">
                <span class="plus-circled">+</span>
              </div>
              <div class="upload-note">添加步骤图</div>
              <file-input name="step_pic" accept="image/*" on-change="{{stepPicUpload}}"></file-input>
              <template if="{{uploading}}">
                <div class="spinner">
                  <paper-spinner active></paper-spinner>
                </div>
              </template>
            </div>
            <div class="step-content">
              <textarea name="step_content">{{step_content}}</textarea>
            </div>
            <ul class="step-ctrl">
              <li class="ctrl-item add-step" on-tap="{{addStep}}"><span class="plus">+</span></li>
              <li class="ctrl-item remove-step" on-tap="{{removeStep}}"><span class="minus">-</span></li>
              <li class="ctrl-item up-step" on-tap="{{upStep}}"><span class="up-dir">&utrif;</span></li>
              <li class="ctrl-item down-step" on-tap="{{downStep}}"><span class="down-dir">&dtrif;</span></li>
            </ul>
          </li>
        </template>
      </ol>
      <h2>小贴士</h2>
      <textarea name="tips" id="tips" rows="4"></textarea>

      <div class="submit-btn">
        <paper-button id="form-submit" on-tap="{{submitForm}}" raised>发布</paper-button>
      </div>

      <div id="hidden-input">
        <input type="text" name="uuid" value="{{uuid}}"/>
        <input type="text" name="cookbook_title" value="{{cookbookTitle}}"/>
        <template repeat="{{ingredients}}">
          <input type="text" name="food_name" value="{{food_name}}"/>
          <input type="text" name="food_quantity" value="{{food_quantity}}"/>
        </template>
      </div>

    </form>
  </template>
  <script>
    (function () {
      Polymer({
        uuid: 0,
        cookbookTitle: '',
        recipeFormUrl: '',
        recipePicUrl: '',
        steps: [
          {step_content: '', uploading: false},
          {step_content: '', uploading: false},
          {step_content: '', uploading: false}
        ],
        ingredients: [
          {food_name: '', food_quantity: ''},
          {food_name: '', food_quantity: ''}
        ],
        mainPicUploading: false,

        upload: function (url, paprams, cb) {
          var xhr = new XMLHttpRequest();
          var formData = new FormData();

          for (var k in paprams){
            formData.append(k, paprams[k]);
          }

          xhr.open('post', url, true);
          xhr.onload = cb;
          xhr.send(formData);
        },

        uploadMainPic: function (ev) {
          this.mainPicUploading = true;

          this.upload(this.recipePicUrl, {
            'index': 0,
            'img': ev.detail.valid[0],
            'uuid': this.uuid
          }, function (e) {
            var ajax = e.target;
            if (ajax.status > 299) console.log('upload fail:' + ajax.status + '  ' + ajax.statusText);
            else {
              //set uuid
            }
            this.mainPicUploading = false;
          })
        },

        stepPicUpload: function (ev) {
          var index = this._findStepItemIndex(ev.path);
          this.steps[index - 1].uploading = true;
          this.upload(this.recipePicUrl, {
            'img': ev.detail.valid[0],
            'uuid': this.uuid,
            'index': index
          }, function (e) {
            var ajax = e.target;
            if (ajax.status > 299) console.log('upload fail:' + ajax.status + '  ' + ajax.statusText);
            else {

            }
            this.steps[index - 1].uploading = false;
          });
        },

        ready: function () {
          this.ingredientsItem = this.$.ingredients.children;
          this.stepItems = this.$.steps.children;

          console.log(this.recipeFormUrl);
        },

        submitForm: function () {
          this.$.form.submit();
        },

        _findStepItemIndex: function (path) {
          var stepItem = null;
          for (var i = 0; i < path.length; i++) {
            if (path[i].className === 'step-item') {
              stepItem = path[i];
              break;
            }
          }

          if (stepItem === null) return -1;

          return Array.prototype.indexOf.call(this.stepItems, stepItem);
        },

        addStep: function (ev) {
          var index = this._findStepItemIndex(ev.path);

          if (index === -1) return;

          this.steps = this.steps.slice(0, index).concat([{step_content: ''}]).concat(this.steps.slice(index, this.steps.length));
        },

        removeStep: function (ev) {
          if (this.steps.length === 1) {
            this.steps = [{step_content: ''}];
            return;
          }
          var index = this._findStepItemIndex(ev.path);

          if (index === -1) return;

          this.steps = this.steps.slice(0, index - 1).concat(this.steps.slice(index, this.steps.length));
        },

        upStep: function (ev) {
          var index = this._findStepItemIndex(ev.path);
          var tmp;

          if (index === 1) return;

          tmp = this.steps[index - 2];
          this.steps[index - 2] = this.steps[index - 1];
          this.steps[index - 1] = tmp;
        },

        downStep: function (ev) {
          var index = this._findStepItemIndex(ev.path);
          var tmp;

          if (index === this.steps.length) return;

          tmp = this.steps[index];
          this.steps[index] = this.steps[index - 1];
          this.steps[index - 1] = tmp;
        },

        _findIngredientItemIndex: function (path) {
          var igdItem = null;
          for (var i = 0; i < path.length; i++) {
            if (path[i].className === 'ingredient-item') {
              igdItem = path[i];
              break;
            }
          }

          if (igdItem === null) return -1;

          return Array.prototype.indexOf.call(this.ingredientsItem, igdItem);
        },

        addIngredient: function (ev) {
          this.ingredients.push({food_name: '', food_quantity: ''});
        },

        deleteIngredient: function (ev) {
          if (this.ingredients.length === 1) {
            this.ingredients = [{food_name: '', food_quantity: ''}];
            return;
          }
          var index = this._findIngredientItemIndex(ev.path);

          if (index === -1) return;

          this.ingredients = this.ingredients.slice(0, index - 1).concat(this.ingredients.slice(index, this.ingredients.length));
        }
      });
    })();
  </script>
</polymer-element>
